<!doctype html>  
<html lang="en">
  
  <head>
    <meta charset="utf-8">
    
    <title>APIs on Rails</title>

    <meta name="description" content="An easy to use CSS 3D slideshow tool for quickly creating good looking HTML presentations.">
    <meta name="author" content="Hakim El Hattab">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href="http://fonts.googleapis.com/css?family=Francois One&subset=latin" rel="stylesheet" type="text/css">
<style>
* {
 font-family: 'Francois One', sans-serif;
}
</style>

    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="stylesheet" href="css/print.css" type="text/css" media="print">

    <link rel="stylesheet" href="lib/css/zenburn.css">
  </head>
  
  <body>
    
    <div class="reveal">

      <!-- Used to fade in a background when a specific slide state is reached -->
      <div class="state-background"></div>
      
      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section>
          <h1>APIs on Rails</h1>
          <h3>Keeping things simple</h3>
        </section>
        
        <section>
          <section>
            <h2>I'm Jonathan Birkholz</h2>
            <a href="http://www.github.com/rookieone">http://www.github.com/rookieone</a>
            <div class="fragment subsection">
              <h2>Ruby Freelancer</h2>
              <a href="http://www.birkholzcreative.com">www.birkholzcreative.com</a>
            </div>
            <div class="fragment subsection">
              <h2>JavaScript Enthusiast</h2>
              <a href="#">www.meetup.com/houston-js</a>
            </div>
          </section>
          <section>
            <h2>Virtual Brown Bag</h2>
            <a href="http://www.virtualbrownbag.com">www.virtualbrownbag.com</a>
            <div class="subsection">
              <p>every Thursday @ 12pm central</p>
              <p>We share tips, tricks, and talk about development</p>
            </div>
            
          </section>
        </section>
        
        <section>
          <section>
            <h1>Overview</h1>  
          </section>
          <section>
            <h2>We will talk about...</h2> 
            <ol class="my-list">
              <li class="fragment">Routes</li>
              <li class="fragment">Versioning</li>
              <li class="fragment">JSON Serialization</li>
              <li class="fragment">JSON Format</li>
              <li class="fragment">Authentication</li>              
            </ol>
          </section>
          <section>
            <h2>What we won't talk about...</h2> 
            <ol class="my-list">
              <li class="fragment">What is REST</li>
              <li class="fragment">What isn't REST</li>
              <li class="fragment">Chic-fil-a</li>
              <li class="fragment">Avengers vs Batman</li>
              <li class="fragment">Who is the best Doctor</li>              
            </ol>
          </section>
          <section>
            <h2>But in case you are wondering...</h2> 
            <ol class="my-list">
              <li class="fragment">Everything good</li>
              <li class="fragment">Everything bad</li>
              <li class="fragment">Yum</li>
              <li class="fragment">Both are awesome</li>
              <li class="fragment">David Tennant</li>              
            </ol>
          </section>          
        </section>

        <section>
          <section>
            <h1>Experience</h1>
            <p>aka... what do I know</p>  
          </section>
          <section class="center-slide">
            <h2>I've consumed APIs</h2>
            <p>On desktop apps, server-side code, and on mobile devices</p>
          </section>
          <section class="center-slide">
            <h2>I've produced APIs</h2>
            <p>For myself, the public, and coworkers on mobile devices</p>            
          </section>
          <section class="center-slide">
            <h2>New(ish) to HTTP</h2>
            <p>Meaning that I tend to google status codes and how headers work</p>
          </section>  
          <section class="center-slide">
            <h2>Made n00b mistakes</h2>
            <p>Therefore can speak with authority on all things that suck</p>
          </section>  
        </section>

        <section class="center-slide">
          <h2>Time to share what I learned</h2>          
        </section>

        <section>
          <h1>Routes</h1>
          <p>They are important</p>          
        </section>

        <section>
          <section>
            <h2>RESTful resources</h2>
            <small>quick review</small>

<pre><code>
resources :dogs
</pre></code>
<pre><code>
   dogs GET    /dogs(.:format)                 dogs#index
        POST   /dogs(.:format)                 dogs#create
new_dog GET    /dogs/new(.:format)             dogs#new
edit_dog GET    /dogs/:id/edit(.:format)        dogs#edit
    dog GET    /dogs/:id(.:format)             dogs#show
        PUT    /dogs/:id(.:format)             dogs#update
        DELETE /dogs/:id(.:format)             dogs#destroy  
</pre></code>
          </section>
          <section>
            <h2>respond_to</h2>     
<pre><code>
  def index
    @dogs = Dog.all
    
    respond_to do |format|
      format.html
      format.json { render :json => @dogs }
    end
  end
</code></pre>                 
          </section>
        
          <section>
            <h2>Web Behavior != API Behavior</h2>
            <p><code>respond_to</code> causes confusion by mixing your web application with your API</p>
          </section>

          <section>
            <h2>How can we separate the two?</h2>
          </section>

          <section>
            <h2>Move API to namespace</h2>
<pre><code>
  namespace :api do
    resources :dogs, :only => [:index]
  end
</code></pre> 
<pre><code>
api_dogs GET /api/dogs(.:format)            api/dogs#index
</code></pre>           
<pre><code>
app/
  controllers/
    api/
      dogs_controller.rb
</code></pre>
<pre><code>
class Api::DogsController < ApplicationController
</code></pre>
          </section>

          <section>
            <h2>Result</h2>
            <ul>
              <li>Moves API to separate classes</li>
              <li>Moves API to separate files and folder structure</li>
            </ul>
          </section>

          
        </section>


        <section>
          <section>
            <h1>Versioning</h1>          
          </section>
          <section>
            <h2>
              <strike>I don't need versioning</strike><br />
              Oh crap! I need versioning
            </h2>
            <br />
            <br />
            <h3>You need to support legacy API calls</h3>
            
          </section>
          <section>
            <h2>100% of mobile users update their applications on a regular basis</h2>
            <h1 class="fragment">FACT</h1>
            <h3 class="fragment">So no need to worry about mobile applications calling legacy api endpoints.</h3>
            <h1 class="fragment">Right?</h1>
          </section>
        </section>
          
        <section>
          <section>
            <h1>Namespacing routes</h1>
          </section>

          <section>
            <h2>It's easy but it does affect the url</h2>
<pre><code>
namespace :v1 do
  resources :dogs
end
</code></pre>
<pre><code>
api_v1_dogs GET /api/v1/dogs(.:format)         api/v1/dogs#index
</code></pre>
<pre><code>
app/
  controllers/
    api/
      v1/
        dogs_controller.rb
</code></pre>
<pre><code>
class Api::V1::DogsController < ApplicationController
</code></pre>
          </section>
        </section>

        <section>
          <section>
            <h1>Version in Header</h1>            
          </section>
          <section>
            <a href="http://freelancing-gods.com/posts/versioning_your_ap_is">http://freelancing-gods.com/posts/versioning_your_ap_is</a>
<pre><code>
namespace :api do
  constrants ApiVersion.new(1) do
    scope :module => :v1 do
      resource :app do
        resources :indices
      end
    end
  end

  constraints ApiVersion.new(2) do
    scope :module => :v2
      resource :app do
        resources :indices
      end
    end
  end
end
</code></pre>
          </section>
          <section>
            <a href="http://freelancing-gods.com/posts/versioning_your_ap_is">http://freelancing-gods.com/posts/versioning_your_ap_is</a>
<pre><code>
# inside class ApiVersion
....
  def matches?(request)
    versioned_accept_header?(request) || version_one?(request)
  end
....

  def versioned_accept_header?(request)
    accept = request.headers['Accept']
    accept && accept[/application\/vnd\.flying-sphinx-v#{@version}\+json/]
  end

  def unversioned_accept_header?(request)
    accept = request.headers['Accept']
    accept.blank? || accept[/application\/vnd\.flying-sphinx/].nil?
  end

....
</code></pre>
          </section>
          <section>
            <h2>Module vs Namespace</h2>
<h3>We get the same folder structure,</h3>            
<pre><code>
app/
  controllers/
    api/
      v1/
      v2/
</code></pre>            
<h3>but doesn't affect the route</h3>
          </section>
        </section>

        <section>
          <section>
            <h1>Versionist</h1>
<pre><code>
gem install versionist
</pre></code>
          </section>
          <section>
            <h2>Accept Header</h2>
            <a href="https://github.com/bploetz/versionist">https://github.com/bploetz/versionist</a>
<pre><code>
api_version(:module => "V1", :header => "Accept", :value => "application/vnd.mycompany.com; version=1") do
  match '/foos.(:format)' => 'foos#index', :via => :get
  match '/foos_no_format' => 'foos#index', :via => :get
  resources :bars
end
</code></pre>                        
          </section>
          <section>
            <h2>Custom Header</h2>
<pre><code>
api_version(:module => "V20120317", :header => "API-VERSION", :value => "v20120317") do
  match '/foos.(:format)' => 'foos#index', :via => :get
  match '/foos_no_format' => 'foos#index', :via => :get
  resources :bars
end
</code></pre>
          </section>
        </section>


        <section>
          <h1>JSONification</h1>
        </section>

        <section>
          <section>
            <h2>to_json</h2>
<pre><code>
@dog.to_json
</code></pre>
<pre><code>
{
  "age": 7, 
  "created_at": "2012-08-05T05:39:30Z", 
  "id": 1, 
  "name": "Penny", 
  "updated_at": "2012-08-05T05:39:30Z"
}
</code></pre>            
          </section>
          <section>
            <h2>as_json</h2>
<pre><code>
def as_json(options={})
  {
    :id => id,
    :name => name
  }
end
</code></pre>
<pre><code>
@dog.to_json
</code></pre>
<pre><code>
{
  "id": 1, 
  "name": "Penny"
}
</code></pre> 
          </section>          
          <section>
            <h2>Whats wrong with to_json?</h2>                      
            <h2 class="fragment">Is the data we return for index of resource the same as the show for that resource?</h2>
          </section>
          <section>
            <h2>Probably not.</h2>

<pre><code>
// dogs#index
[
  { "id": 1, "name": "Penny" },
  { "id": 2, "name": "Moon" },
  { "id": 3, "name": "Tugboat" },
]
</code></pre> 
<pre><code>
// dogs#show
{
  "id": 1, 
  "name": "Penny",
  "age": 7,
  "owner": "Suzanne"
}
</code></pre>             
          </section>   
        </section>
        
        <section>
          <h1>Other options?</h1>
        </section>

        <section>
          <section>
            <h1>boxer</h1>
<pre><code>
gem install boxer
</code></pre>            
          </section>      
          <section>
            <h2>Configure</h2>
<pre><code>
/config/initializers/boxer.rb
</code></pre>   
<pre><code>
Boxer.box(:dog) do |boxer, dog|
  {
    :name => dog.name,
    :age  => dog.age,
  }
end
</code></pre>                  
          </section>    
          <section>
            <h2>Object</h2>
<pre><code>
def show
  @dog = Dog.find(params[:id])
  render :json => Boxer.ship(:dog, @dog)
end
</code></pre> 
</section>
<section>
            <h2>Collection</h2>
<pre><code>
def index
  @dogs = Dog.all
  render :json => @dogs.map{|d| Boxer.ship(:dog, d)}
end
</code></pre>        
</section>     
          <section>
            <h2>Easy to setup json format for object</h2>
            <hr />
            <h2>Keeps jsonification separate from model definition</h2>            
          </section>
        </section>

        <section>
          <section>
            <h1>rabl</h1>
<pre><code>
gem install rabl
</code></pre>                
          </section>
        <section>
            <h2>Object</h2>
<pre><code>
  app/controllers/api/dogs_controller.rb
</pre></code>
<pre><code>
def show
  @dogs = Dog.find(params[:id])
end
</code></pre>
<hr />
<pre><code>
  app/controllers/api/show.rabl
</pre></code>
<pre><code>
object @dog
attributes :id, :name, :age
</code></pre>
          </section>        
          <section>
            <h2>Collections</h2>
<pre><code>
  app/controllers/api/dogs_controller.rb
</pre></code>
<pre><code>
def index
  @dogs = Dog.all
end
</code></pre>
<hr />
<pre><code>
  app/views/api/dogs/index.rabl
</pre></code>
<pre><code>
collection @dogs, :root => "dogs"
attributes :id, :name, :age
</code></pre>
          </section>    
          <section>
            <h2>Keeps jsonification separate from model definition</h2> 
            <hr />
            <h2>Follows same pattern as normal rails html views</h2>

          </section>
        </section>

        <section>
          <section>
            <h2>JSONification Problem Summary</h2>
            <h3>to_json assumes common format of model for all requests</h3>
            <h3>Muddies models with API concerns</h3>
          </section>
          <section>
            <h2>JSONification Solution Summary</h2>
            <h3>Serializers / Presenters</h3>
            <h3>gem <code>boxer</code></h3>
            <h3>gem <code>rabl</code></h3>
          </section>          
        </section>
          
        
          <section>
            <h1>Formatting your response</h1>
          </section>
        <section>
          <section>
            <h2>root level</h2>
            <p>You should return a root key to identify what you are returning.</p>
          </section>
          <section data-state="alert">
            <h2>Is this a user?</h2>
            <pre><code>
            {
              name: "Penny",
              age: 7
            }
            </code></pre>
          </section>
          <section data-state="soothe">
            <h2>Oh, its a dog.</h2>
            <pre><code>
            { 
              dog: {
                name: "Penny",
                age: 7
              }
            }
            </code></pre>
          </section>                   
        </section>

        <section>
          <section>
            <h2>Details</h2>
            <p>Return more than just the type, code, or id.</p>
          </section>
          <section data-state="alert">
            <h2>WTF is type 3?</h2>
            <pre><code>
            { 
              dog: {
                name: "Penny",
                age: 7,
                type: 3
              }
            }
            </code></pre>            
          </section>
          <section data-state="soothe">
            <h2>Thanks for the info</h2>
            <pre><code>
            { 
              dog: {
                name: "Penny",
                age: 7,
                type: {
                  id: 3,
                  name: "Greyhound"
                }
              }
            }
            </code></pre>            
          </section>    
        </section>
        <section>          
          <section>
            <h2>Same for collections</h2>
            <p>Return more than just the type, code, or id.</p>
          </section>      
          <section data-state="alert">
            <h2>She must be so proud of 3 & 7</h2>
            <pre><code>
            { 
              user: {
                name: "Suzanne",
                dogs: [3, 7]
              }
            }
            </code></pre>            
          </section>
          <section data-state="soothe">
            <h2>Much better</h2>
            <pre><code>
            { 
              user: {
                name: "Suzanne",
                dogs: [
                  { id: 3, name: "Penny" }, 
                  { id: 7, name: "Moon" }
                ]
              }
            }
            </code></pre>            
          </section>
        </section>

        <section>
          <section>
            <h2>passing urls</h2>
          </section>          
          <section>
            <h2>objective-c string parsing</h2>
          </section>
          <section data-state="alert">
            <h2>What if I want more information on Moon?</h2>
            <pre><code>
            { 
              user: {
                name: "Suzanne",
                dogs: [
                  { id: 3, name: "Penny" }, 
                  { id: 7, name: "Moon" }
                ]
              }
            }
            </code></pre>            
          </section> 
          <section>            
            <h2>Steps to getting Moon's information</h2>
          <ol>
            <li>Figure out correct url</li>
            <li>Build the url from the data provided</li>
            <li>Make http request</li>
          </ol>
          <h2 class="fragment">Tedius and Annoying</h2>
          </section>
          
          <section data-state="soothe">
<h2>No more string parsing!</h2>
<pre><code>{ 
  user: {
    name: "Suzanne",
    dogs: [
      { 
        id: 3, 
        name: "Penny", 
        url: "http://foodogfoo.com/api/dogs/3" 
      }, { 
        id: 7, 
        name: "Moon", 
        url: "http://foodogfoo.com/api/dogs/7" 
      } 
    ]
  }
}</code></pre>            
          </section>     
          <section>
            <h2>Bonus!</h2>
            <p>does the user of this api who navigates using the url given actually care about the url contents?</p>
            <p>so we can change the url to that resource and mobile apps won't care</p>
          </section>
        </section>

        <section>
          <h1>Authentication</h1>
        </section>

        <section>
          <section>
            <h2>HTTP Basic</h2>
<pre><code>
class Api::HttpBasic::BaseController < ApplicationController
  before_filter :authenticate

  protected

  def authenticate
    authenticate_or_request_with_http_basic do |username, password|
      username == "api_user" && password == "super_easy"
    end
  end
end
</code></pre>            
          </section>
          <section>
            <h2>Easy, peasy</h2>
<pre><code>

context "with authentication" do
  before(:each) do
    auth = ActionController::HttpAuthentication::Basic.encode_credentials "api_user", "super_easy"        
    get api_http_basic_dogs_path, {}, 'HTTP_AUTHORIZATION' => auth
  end
  it "should return 200 status code" do
    response.code.should == "200"
  end
end

</code></pre>            
        </section>
      </section>

        <section>
          <section>
            <h1>API Token</h1>
          </section>
          <section>
            <h2>Rolling your own</h2>
            <a href="http://railscasts.com/episodes/352-securing-an-api?view=asciicast">http://railscasts.com/episodes/352-securing-an-api?view=asciicast</a>
          </section>
          <section>
            <h2>ApiKey</h2>
<pre><code>
class ApiKey < ActiveRecord::Base
  before_create :generate_api_token
  
  private

  def generate_api_token
    self.api_token = SecureRandom.hex
  end
end
</code></pre> 
<pre><code>SecureRandom.hex -> c8fd0259715241cd1ad1f7640022258c</code></pre>
          </section>
          <section>
            <h2>Checking Token via param</h2>
<pre><code>
  before_filter :check_token

  protected

  def check_token
    api_token = ApiKey.find_by_api_token(params[:api_token])
    head :unauthorized unless api_token    
  end
</code></pre>            
          </section>        

          <section>
            <h2>Checking Token via header</h2>
<pre><code>
  before_filter :check_token

  protected

  def check_token
    authenticate_or_request_with_http_token do |token, options|
      ApiKey.exists?(:api_token => token)
    end
  end
</code></pre>            
          </section>

        </section>

        <section>
          <section>
            <h1>Devise</h1>
          </section>  
          <section>
<h2>Token Authenticable</h2>
<pre><code>

devise :database_authenticatable, :registerable,
       :recoverable, :rememberable, :trackable, :validatable,
       :token_authenticatable

</code></pre>
<pre><code>
# be sure to add column
t.string :authentication_token
</code></pre>
<pre><code>
# User model
before_save :ensure_authentication_token 
</code></pre>
          </section>
          <section>
            <h2>Passing token in request</h2>
<pre><code>
# first request
get api_devise_token_dogs_path(:auth_token => @user.authentication_token)
</code></pre>            
<h2>No need to pass token with next request</h2>
<pre><code>
#second request
get api_devise_token_dogs_path
</code></pre>
          </section>

        </section>        

        <section>
          <h2>Authentication Summary</h2>
          <ul>
            <li>HTTP Basic</li>
            <li>Custom Token</li>
            <li>Devise</li>
          </ul>
        </section>

        <section>
          <h1>Review</h1>
        </section>

        <section>
          <h1>Questions?</h1>          
        </section>
      </div>

      <!-- The navigational controls UI -->
      <aside class="controls">
        <a class="left" href="#">&#x25C4;</a>
        <a class="right" href="#">&#x25BA;</a>
        <a class="up" href="#">&#x25B2;</a>
        <a class="down" href="#">&#x25BC;</a>
      </aside>

      <!-- Presentation progress bar -->
      <div class="progress"><span></span></div>
      
    </div>

    <script src="lib/js/head.min.js"></script>

    <script>
      // Scripts that should be loaded before initializing
      var scripts = [];

      // If the browser doesn't support classList, load a polyfill
      if( !document.body.classList ) {
        scripts.push( 'lib/js/classList.js' );
      }

      // Load markdown parser if there are slides defined using markdown
      if( document.querySelector( '[data-markdown]' ) ) {
        scripts.push( 'lib/js/showdown.js' );
        scripts.push( 'lib/js/data-markdown.js' );
      }

      // If we're runnning the notes server we need to include some additional JS
      // TODO Is there a better way to determine if we're running the notes server?
      if( window.location.host === 'localhost:1947' ) {
        scripts.push( 'socket.io/socket.io.js' );
        scripts.push( 'plugin/speakernotes/client.js' );
      }

      scripts.push( 'js/reveal.js' );

      // Load the scripts and, when completed, initialize reveal.js
      head.js.apply( null, scripts.concat([function() {

        // Fires when a slide with data-state=customevent is activated
        Reveal.addEventListener( 'customevent', function() {
          console.log( '"customevent" has fired' );
        } );

        // Fires each time a new slide is activated
        Reveal.addEventListener( 'slidechanged', function( event ) {
          // event.previousSlide, event.currentSlide, event.indexh, event.indexv
        } );

        // Full list of configuration options available here:
        // https://github.com/hakimel/reveal.js#configuration
        Reveal.initialize({
          controls: true,
          progress: true,
          history: true,
          
          theme: Reveal.getQueryHash().theme || 'default', // default/neon/beige
          transition: Reveal.getQueryHash().transition || 'default' // default/cube/page/concave/linear(2d)
        });

      }]));
      
      // Load highlight.js for syntax highlighting of code samples
      head.js( 'lib/js/highlight.js', function() { 
        hljs.initHighlightingOnLoad(); 
      } );
    </script>

  </body>
</html>